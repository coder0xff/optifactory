<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optifactory - Factory Planner</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
    <script src="highs.cjs"></script>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="app-title">Optifactory - Factory Planner</div>
            <button @click="shareDesign" class="share-button" title="Share current design as link">
                Share Design
            </button>
        </div>

        <div class="tabs">
            <div 
                class="tab" 
                :class="{ active: activeTab === 'factory' }"
                @click="activeTab = 'factory'"
            >
                Factory
            </div>
            <div 
                class="tab" 
                :class="{ active: activeTab === 'economy' }"
                @click="activeTab = 'economy'"
            >
                Economy
            </div>
            <div 
                class="tab" 
                :class="{ active: activeTab === 'docs' }"
                @click="activeTab = 'docs'"
            >
                Documentation
            </div>
        </div>

        <!-- Factory Tab -->
        <div class="tab-content" :class="{ active: activeTab === 'factory' }">
            <factory-view
                ref="factoryView"
                :controller="factoryController"
                @status-change="handleStatusChange"
                @state-change="handleStateChange"
            />
        </div>

        <!-- Economy Tab -->
        <div class="tab-content" :class="{ active: activeTab === 'economy' }">
            <economy-view
                ref="economyView"
                :controller="economyController"
                @status-change="handleStatusChange"
                @state-change="handleStateChange"
            />
        </div>

        <!-- Documentation Tab -->
        <div class="tab-content" :class="{ active: activeTab === 'docs' }">
            <docs-view @status-change="handleStatusChange" />
        </div>

        <div class="status-bar" :class="statusClass">{{ statusText }}</div>
    </div>

    <script type="module">
        import { EconomyController } from './economy-controller.js';
        import { FactoryController } from './factory-controller.js';
        import { FactoryViewComponent } from './factory-editor.js';
        import { EconomyViewComponent } from './economy-editor.js';
        import { DocsViewerComponent } from './docs-viewer.js';
        import { encodeStateToBase64, decodeStateFromBase64, loadStateFromUrlHash } from './state-encoding.js';

        const { createApp } = Vue;

        // ============================================================================
        // LocalStorage State Persistence
        // ============================================================================

        const STORAGE_KEY = 'optifactory_state';
        const STORAGE_VERSION = 1;

        /**
         * Save complete application state to localStorage.
         * @param {string} activeTab - current active tab
         * @param {FactoryController} factoryController - factory controller instance
         * @param {EconomyController} economyController - economy controller instance
         */
        function saveStateToLocalStorage(activeTab, factoryController, economyController) {
            try {
                const state = {
                    version: STORAGE_VERSION,
                    activeTab: activeTab,
                    factoryState: factoryController.serialize_state(),
                    economyState: economyController.save_to_csv()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                console.log('State saved to localStorage');
            } catch (error) {
                console.error('Failed to save state to localStorage:', error);
            }
        }

        /**
         * Load application state from localStorage.
         * @returns {Object|null} state object or null if no saved state exists
         */
        function loadStateFromLocalStorage() {
            try {
                const stateJson = localStorage.getItem(STORAGE_KEY);
                if (!stateJson) {
                    console.log('No saved state found in localStorage');
                    return null;
                }
                
                const state = JSON.parse(stateJson);
                if (state.version !== STORAGE_VERSION) {
                    console.warn(`Unsupported state version ${state.version}, ignoring saved state`);
                    return null;
                }
                
                console.log('State loaded from localStorage');
                return state;
            } catch (error) {
                console.error('Failed to load state from localStorage:', error);
                return null;
            }
        }

        createApp({
            components: {
                'factory-view': FactoryViewComponent,
                'economy-view': EconomyViewComponent,
                'docs-view': DocsViewerComponent
            },
            data() {
                return {
                    activeTab: 'factory',
                    statusText: 'Ready',
                    statusClass: '',
                    economyController: null,
                    factoryController: null,
                    loadedFromHash: false
                };
            },
            created() {
                // Initialize controllers before components mount (economy shares data with factory)
                this.economyController = new EconomyController();
                this.factoryController = new FactoryController(this.economyController.economy);
                
                // Check URL hash first (takes precedence over localStorage)
                let savedState = loadStateFromUrlHash();
                if (savedState) {
                    console.log('Loading state from URL hash');
                    this.loadedFromHash = true;
                } else {
                    // Fall back to localStorage
                    savedState = loadStateFromLocalStorage();
                }
                
                if (savedState) {
                    this.restoreState(savedState);
                    this._hasRestoredState = true;
                } else {
                    this._hasRestoredState = false;
                }
            },
            mounted() {
                // If no restored state, generate initial factory
                if (!this._hasRestoredState) {
                    this.generateInitialFactory();
                }
            },
            methods: {
                restoreState(savedState) {
                    try {
                        // Restore active tab
                        this.activeTab = savedState.activeTab;
                        
                        // Restore economy controller state
                        this.economyController.load_from_csv(savedState.economyState);
                        
                        // Restore factory controller state (includes graphviz cache)
                        this.factoryController.deserialize_state(savedState.factoryState);
                        
                        // Update economy reference in factory controller
                        this.factoryController.economy = this.economyController.economy;
                        
                        const statusMessage = this.loadedFromHash 
                            ? 'Shared design loaded' 
                            : 'Previous session restored';
                        this.setStatus(statusMessage, 'info');
                        console.log('State restored successfully');
                    } catch (error) {
                        console.error('Failed to restore state:', error);
                        const errorMessage = this.loadedFromHash
                            ? 'Failed to load shared design'
                            : 'Failed to restore previous session';
                        this.setStatus(errorMessage, 'warning');
                        // Fall back to generating initial factory
                        this.generateInitialFactory();
                    }
                },
                generateInitialFactory() {
                    this.$nextTick(() => {
                        const factoryView = this.$refs.factoryView;
                        if (factoryView) {
                            factoryView.generateFactory().then(() => {
                                this.setStatus('Welcome to Optifactory!');
                            });
                        } else {
                            console.error('Factory view ref not found');
                            this.setStatus('Welcome to Optifactory!');
                        }
                    });
                },
                saveState() {
                    if (this.factoryController && this.economyController) {
                        // Clear hash on first state change after loading from shared link
                        if (this.loadedFromHash) {
                            window.history.replaceState(null, '', window.location.pathname);
                            this.loadedFromHash = false;
                        }
                        
                        saveStateToLocalStorage(
                            this.activeTab,
                            this.factoryController,
                            this.economyController
                        );
                    }
                },
                shareDesign() {
                    if (!this.factoryController || !this.economyController) {
                        this.setStatus('No design to share', 'warning');
                        return;
                    }
                    
                    try {
                        // Build state object (same as localStorage format)
                        const state = {
                            version: STORAGE_VERSION,
                            activeTab: this.activeTab,
                            factoryState: this.factoryController.serialize_state(),
                            economyState: this.economyController.save_to_csv()
                        };
                        
                        // Encode to base64
                        const base64State = encodeStateToBase64(state);
                        
                        // Update URL hash
                        const shareUrl = `${window.location.origin}${window.location.pathname}#share=${base64State}`;
                        window.history.replaceState(null, '', `#share=${base64State}`);
                        
                        // Set flag so hash will be cleared on next state change
                        this.loadedFromHash = true;
                        
                        // Try to copy to clipboard
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(shareUrl)
                                .then(() => {
                                    this.setStatus('Share link copied to clipboard!', 'info');
                                })
                                .catch(err => {
                                    console.error('Failed to copy to clipboard:', err);
                                    this.setStatus('Share link in URL (copy from address bar)', 'info');
                                });
                        } else {
                            this.setStatus('Share link in URL (copy from address bar)', 'info');
                        }
                    } catch (error) {
                        console.error('Failed to create share link:', error);
                        this.setStatus('Failed to create share link', 'error');
                    }
                },
                handleStatusChange(event) {
                    this.setStatus(event.text, event.level);
                },
                handleStateChange() {
                    this.saveState();
                },
                setStatus(text, level = 'info') {
                    this.statusText = text;
                    if (level === 'error') {
                        this.statusClass = 'error';
                    } else if (level === 'warning') {
                        this.statusClass = 'warning';
                    } else {
                        this.statusClass = '';
                    }
                }
            },
            watch: {
                activeTab() {
                    this.saveState();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
